# 40 节点网络不通排查与修复（192.168.1.14 / 192.168.0.222）

## 现象

- **ping 192.168.1.14**：`From 192.168.1.106 icmp_seq=2 Destination Host Unreachable`
  - 表示包已到达 192.168.1.106，但该主机**没有到 192.168.1.14 的路由**，因此由 192.168.1.106 回复“目的不可达”。
- **ping 192.168.0.222**：无响应
  - 可能原因：本机无路由（包未发出）、中间节点静默丢包、或 192.168.0.222 所在容器未启动/未配置。

---

## 一、先确认基础信息

在**执行 ping 的那台容器**里执行：

```bash
# 1. 本机是否有到目标的路由
ip route get 192.168.1.14
ip route get 192.168.0.222

# 2. 本机网口与地址
ip -4 addr show
```

- 若 `ip route get` 报错或没有合理下一跳，说明**缺路由**。
- 若显示 “Network is unreachable”，说明本机就没有到该网段的路由。

在**目标所在容器**里确认：

- 192.168.1.14 → 应在 **consensus_node_37**（node38 的 chainmaker 配置里 listen_addr 可能用 192.168.1.14 或同网段）。
- 192.168.0.222 → 应在 **consensus_node_31**（node32）。

在对应容器里执行：

```bash
# 在 node31 容器（应有 192.168.0.222 的接口）
ip -4 addr show

# 在 node37 容器（应有 192.168.1.14 的接口）
ip -4 addr show
```

确认 192.168.0.222、192.168.1.14 是否已配置且接口为 UP。

---

## 二、192.168.1.14：Destination Host Unreachable from 192.168.1.106

含义：**192.168.1.106 这台设备没有到 192.168.1.14 的路由**。

### 2.1 确认 192.168.1.106 对应哪台容器

40 节点时，`address_mapping.conf` 里**没有** 192.168.1.106 所在网段；路由表里“下一跳”是节点号（如 106），不一定是 IP。

- 若你实际只有 40 个共识节点（0–39），**通常不会有 192.168.1.106**，回复不可达的更有可能是 **192.168.0.106**（consensus_node14 的 192.168.0.106/30）。
- 在**所有共识节点容器**里执行：`ip addr | grep 106`，看谁有 `.106` 的地址。

### 2.2 让“回复不可达的那台”学到 192.168.1.14 的路由

192.168.1.14/30 由 **consensus_node_37** 在 FRR 里宣告（`resources/frr/consensus_node_37.conf` 中有 `network 192.168.1.12/30`，覆盖 192.168.1.12–15）。

- **做法 1：依赖 OSPF（推荐）**  
  - 在“回复不可达”的那台容器里执行：
    ```bash
    vtysh -c "show ip ospf neighbor"
    vtysh -c "show ip route"
    ```
  - 若能看到 OSPF 邻居，且 `show ip route` 里有 `192.168.1.14/30` 或 `192.168.1.12/30`，说明路由已学到，此时不应再出现“来自该机的 Destination Host Unreachable”。
  - 若**没有**到 192.168.1.12/30 或 192.168.1.14 的路由，说明 OSPF 没把 node37 的网段传过来，需要检查：
    - node37 的 FRR 是否正常：`service frr status`，`vtysh -c "show ip route"`
    - 从 192.168.0.x 到 192.168.1.x 的“桥”节点 **node32**（同时有 192.168.0.230 和 192.168.1.1）的 FRR 和链路是否正常；node32 的 OSPF 必须和 192.168.0 侧、192.168.1 侧都建邻。

- **做法 2：临时静态路由（仅作验证）**  
  在**回复 “From 192.168.1.106” 的那台**容器里（或确认后的 192.168.0.106 那台），增加一条到 192.168.1.14 网段的静态路由，下一跳设为你能 ping 通的、更靠近 node37 的一台（例如与 node37 直连或同属 192.168.1.x 的节点）：

  ```bash
  # 示例：若下一跳应为 192.168.1.10（node34 的某接口）
  ip route add 192.168.1.12/30 via 192.168.1.10
  ```

  再加一次 `ping 192.168.1.14`。若能通，说明问题就是 OSPF 未收敛或未覆盖到该节点，再回头查 FRR/链路。

---

## 三、192.168.0.222：ping 无响应

192.168.0.222 在 **consensus_node_31**（address_mapping：192.168.0.222/30），FRR 里由 node31 宣告 192.168.0.220/30。

### 3.1 在 ping 源容器

```bash
ip route get 192.168.0.222
```

- 无路由或 unreachable：说明本机或上游没有到 192.168.0.222 的路由，需要查 OSPF/静态路由或 veth 是否只做了 16 节点而没做 31。

### 3.2 在 node31 容器（应有 192.168.0.222 的节点）

```bash
ip -4 addr show
ping -c 2 127.0.0.1
```

- 若没有 192.168.0.222 的地址，或接口 DOWN：说明该节点网络未按 40 节点正确配置（例如只配了 16 节点的 veth/地址）。
- 若 node31 容器没起来：需要先保证 40 个共识节点容器都启动，再查路由。

### 3.3 中间节点是否丢包

若你有多台可登录的节点，从 ping 源开始，按 `resources/routes/consensus_node_*.conf` 里到 dest 31 的路径，逐跳 `ping 下一跳 IP`，看在哪一跳开始无响应，便于判断是缺路由还是链路/接口问题。

---

## 四、40 节点与 16 节点的差异（为何 16 节点正常）

- **16 节点**：节点和子网大多在 192.168.0.x，链路和路由较简单，OSPF 易收敛。
- **40 节点**：
  - 节点 33–40 使用 192.168.1.x，**必须**通过同时拥有 192.168.0 和 192.168.1 的 **node32** 与 192.168.0.x 互通。
  - 若 veth/网络只为 16 节点创建，则 node31、node32、node37 等可能没有正确接口或未互联，会导致 192.168.0.222 无响应、192.168.1.14 不可达。

请确认：

1. 启动 40 节点时，**是否用 40 节点的拓扑/脚本**创建了全部 veth 和接口（即包含到 node31、node32、node37 的链路）。
2. 每个共识节点是否挂载了**对应 NODE_ID** 的 FRR 配置（如 `consensus_node_31.conf`、`consensus_node_37.conf`），并且 `service frr start` 已执行。

---

## 五、建议操作顺序（简短）

1. 在 **ping 源**：`ip route get 192.168.1.14` 和 `ip route get 192.168.0.222`，确认是否有路由。
2. 在 **回复 “From 192.168.1.106” 的机器**（或 192.168.0.106）：`vtysh -c "show ip route"`，看是否有 192.168.1.12/30 或 192.168.1.14。
3. 在 **node31**：确认存在 192.168.0.222 且接口 UP；在 **node37**：确认存在 192.168.1.14 且接口 UP。
4. 在 **node32**：`vtysh -c "show ip ospf neighbor"` 与 `show ip route`，确认其同时与 192.168.0 侧和 192.168.1 侧建邻并学到两边路由。
5. 若 OSPF 短期无法修好，可在“回复不可达”的那台加**临时静态路由**到 192.168.1.12/30（下一跳指向 192.168.1.x 中可达的一台），验证 192.168.1.14 可达性；192.168.0.222 则需保证 node31 已启动且 40 节点 veth/地址已配置。

若你提供：当前是 40 个共识节点容器、还是更多卫星节点，以及“回复不可达”那台的实际 IP（是否是 192.168.0.106），可以再针对性给出该机上的具体静态路由命令和 OSPF 检查点。
